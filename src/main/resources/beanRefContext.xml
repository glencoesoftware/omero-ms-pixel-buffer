<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">
  <description>
        Defines the beans for the pixel data microservice.
  </description>

  <bean name="filesystem"  abstract="true">
    <constructor-arg index="0" value="${omero.data.dir}"/>
    <constructor-arg index="1" type="boolean" value="true"/>
  </bean>

  <bean id="omeroFilePathResolver" class="ome.services.OmeroFilePathResolver">
    <constructor-arg value="${omero.data.dir}"/>
    <constructor-arg ref="simpleSqlAction"/>
  </bean>

  <!-- Casting string to Long to prevent the wrong ctor from being used -->
  <bean name="MemoizerWait" class="java.lang.Long">
    <constructor-arg value="${omero.pixeldata.memoizer_wait}"/>
  </bean>

  <bean id="backOff" class="${omero.pixeldata.backoff}">
    <constructor-arg ref="tileSizes"/>
  </bean>

  <bean id="configuredTileSizes" class="ome.io.nio.ConfiguredTileSizes">
    <constructor-arg index="0" value="${omero.pixeldata.tile_width}"/>
    <constructor-arg index="1" value="${omero.pixeldata.tile_height}"/>
    <constructor-arg index="2" value="${omero.pixeldata.max_plane_width}"/>
    <constructor-arg index="3" value="${omero.pixeldata.max_plane_height}"/>
  </bean>

  <alias name="${omero.pixeldata.tile_sizes_bean}" alias="tileSizes"/>

  <alias name="${omero.metrics.bean}" alias="metrics"/>

  <bean id="defaultMetrics" class="ome.system.metrics.DefaultMetrics">
    <property name="slf4jMinutes" value="${omero.metrics.slf4j_minutes}"/>
    <property name="beginsWith">
        <list><value>ome.services.pixeldata</value></list>
    </property>
    <property name="graphiteAddress" value="${omero.metrics.graphite}"/>
  </bean>

  <bean id="metrics" class="ome.system.metrics.NullMetrics"/>
  
  <bean name="/OMERO/Pixels" class="com.glencoesoftware.omero.ms.image.region.PixelsService"
        parent="filesystem">
    <!-- index=0 "path" comes from parent -->
    <constructor-arg index="2" value="${omero.pixeldata.memoizer.dir}"/>
    <constructor-arg index="3" ref="MemoizerWait"/>
    <constructor-arg index="4" ref="omeroFilePathResolver"/>
    <constructor-arg index="5" ref="backOff"/>
    <constructor-arg index="6" ref="tileSizes"/>
    <constructor-arg index="7" ><null /></constructor-arg>
    <constructor-arg index="8" value="${omero.pixeldata.zarr_cache_size:500}" />
    <constructor-arg index="9" value="${omero.pixeldata.max_plane_width:3192}" />
    <constructor-arg index="10" value="${omero.pixeldata.max_plane_height:3192}" />
    <property name="metrics" ref="metrics"/>
  </bean>

  <bean id="omero-ms-pixel-buffer-verticle"
        class="com.glencoesoftware.omero.ms.pixelbuffer.PixelBufferVerticle"
        scope="prototype">
    <constructor-arg ref="/OMERO/Pixels" />
  </bean>

</beans>
